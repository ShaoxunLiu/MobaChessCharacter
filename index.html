<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è§’è‰²å¡ (Excel ç›´è¯»ç‰ˆ)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        /* --- æ ·å¼ä¿æŒä¸å˜ --- */
        :root {
            --primary: #4a90e2;
            --primary-dark: #357abd;
            --bg: #f0f2f5;
            --card-bg: #ffffff;
            --text: #333;
            --text-light: #666;
            --border: #e1e4e8;
            --accent: #ff6b6b;
            --gem-color: #9b59b6;
            --success: #2ecc71;
            --warning: #f1c40f;
            
            --skill-locked-bg: #f5f5f5;
            --skill-locked-border: #ddd;
            --skill-locked-text: #aaa;
            --skill-avail-border: #4a90e2;
            --skill-avail-bg: #fff;
            --skill-learned-bg: #e3f2fd;
            --skill-learned-border: #4a90e2;
            --skill-learned-text: #4a90e2;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #app {
            width: 100%;
            height: 100%;
            max-width: 500px;
            background: var(--card-bg);
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        button { touch-action: manipulation; }

        .tabs {
            flex-shrink: 0;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border);
            z-index: 10;
        }
        .tab-button {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 15px;
            font-weight: bold;
            color: var(--text-light);
            background: transparent;
            border: none;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .tab-button.active {
            color: var(--primary);
            background-color: rgba(74, 144, 226, 0.1);
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        .header {text-align: center;margin-bottom: 15px;}
        .header h1 {font-size: 24px;margin: 0;color: var(--primary);}
        .input-group {margin-bottom: 15px;}
        .input-group label {display: block;font-weight: bold;margin-bottom: 5px;font-size: 14px;}
        .input-group input[type="text"] {width: 100%;padding: 10px;border: 1px solid var(--border);border-radius: 6px;box-sizing: border-box;font-size: 16px;}
        
        .stats-area {border: 1px solid var(--border);border-radius: 8px;padding: 15px;margin-bottom: 20px;}
        .stats-area h2 {font-size: 18px;margin-top: 0;padding-bottom: 5px;border-bottom: 1px solid var(--border);}
        .stat-item {display: flex;justify-content: space-between;align-items: center;margin-bottom: 10px;padding: 5px 0;border-bottom: 1px dotted var(--border);}
        .stat-name {font-weight: bold;width: 80px;}
        .stat-value {display: flex;align-items: center;}
        .stat-value button {width: 30px;height: 30px;font-size: 18px;line-height: 1;border: none;border-radius: 4px;cursor: pointer;background-color: var(--primary);color: white;margin: 0 5px;}
        .stat-value button:disabled {background-color: #ccc;cursor: not-allowed;}
        .stat-points {width: 25px;text-align: center;font-weight: bold;font-size: 16px;}

        .derived-hp-gem {display: grid;grid-template-columns: repeat(2, 1fr);gap: 10px;margin-bottom: 20px;}
        .derived-item, .hp-item, .gem-item {border: 1px solid var(--border);border-radius: 6px;padding: 10px;text-align: center;}
        .derived-item strong, .hp-item strong, .gem-item strong {display: block;font-size: 14px;margin-bottom: 5px;color: #666;}
        .derived-value, .hp-value {font-size: 20px;font-weight: bold;color: var(--primary);}
        .gem-value {font-size: 20px;font-weight: bold;color: var(--gem-color);}
        
        .hp-adjust, .gem-adjust {display: flex;justify-content: center;align-items: center;margin-top: 5px;}
        .hp-adjust input {width: 40px;text-align: center;border: 1px solid var(--border);border-radius: 4px;margin: 0 5px;}
        .hp-adjust button, .gem-adjust button {padding: 5px 10px;border: none;border-radius: 4px;cursor: pointer;color: white;margin: 0 2px;}
        .hp-adjust button {background-color: var(--accent);}
        .hp-adjust button.heal {background-color: var(--success);}
        .gem-adjust button {background-color: var(--gem-color);}
        .current-hp-value {color: var(--accent);}
        .notes-area textarea {width: 100%;height: 100px;padding: 10px;border: 1px solid var(--border);border-radius: 6px;box-sizing: border-box;font-size: 14px;resize: vertical;}

        .skill-tree-content select {width: 100%;padding: 10px;margin-bottom: 15px;border: 1px solid var(--border);border-radius: 6px;font-size: 16px;}
        .skill-tree-image-container {width: 100%;height: 400px;border: 1px solid var(--border);border-radius: 6px;background-color: #f9f9f9;overflow: hidden;position: relative;}
        .skill-tree-image-container img {max-width: none;width: 100%;min-width: 300px;display: block;touch-action: none;user-select: none;transform-origin: 0 0;cursor: grab;}
        .skill-tree-image-container img.is-dragging {cursor: grabbing;}

        .sb-nav-container {position: relative;margin-bottom: 15px;}
        .sb-nav-container::after {content: ''; position: absolute; right: 0; top: 0; bottom: 0; width: 20px;background: linear-gradient(to right, transparent, var(--card-bg));pointer-events: none;}
        .sb-nav-container::before {content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 20px;background: linear-gradient(to left, transparent, var(--card-bg));pointer-events: none;z-index: 2;}

        .sb-class-nav {display: flex;gap: 10px;overflow-x: auto;padding: 5px 5px 15px 5px;touch-action: pan-x; cursor: grab;user-select: none;-webkit-user-select: none;}
        .sb-class-nav:active { cursor: grabbing; }
        
        .sb-class-btn {white-space: nowrap;padding: 6px 14px;border-radius: 15px;border: 1px solid var(--border);background: white;color: var(--text);font-size: 14px;cursor: pointer;flex-shrink: 0;transition: all 0.2s;pointer-events: auto;}
        .sb-class-btn.active {background: var(--primary);color: white;border-color: var(--primary);box-shadow: 0 2px 5px rgba(74, 144, 226, 0.3);transform: scale(1.05);}

        .sb-tier-row { display: flex; margin-bottom: 20px; border-bottom: 1px dashed var(--border); padding-bottom: 15px; }
        .sb-tier-label { width: 30px; flex-shrink: 0; font-family: "Times New Roman", serif; font-size: 24px; font-weight: bold; color: var(--primary-dark); border-right: 3px solid var(--primary); margin-right: 12px; display: flex; align-items: flex-start; justify-content: center; padding-top: 5px; }
        .sb-tier-skills { flex: 1; display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 8px; }

        .sb-skill-card {aspect-ratio: 1;border-radius: 6px;padding: 5px;display: flex;flex-direction: column;justify-content: center;align-items: center;text-align: center;cursor: pointer;font-size: 12px;transition: transform 0.1s;user-select: none;position: relative;}
        .sb-skill-card:active { transform: scale(0.96); }
        .sb-skill-name { font-weight: bold; line-height: 1.2; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .sb-skill-type { font-size: 10px; margin-top: 2px; opacity: 0.8; }

        .sb-skill-card.locked { background: var(--skill-locked-bg); border: 1px solid var(--skill-locked-border); color: var(--skill-locked-text); }
        .sb-skill-card.available { background: var(--skill-avail-bg); border: 1px dashed var(--skill-avail-border); color: var(--text); }
        .sb-skill-card.learned { background: var(--skill-learned-bg); border: 2px solid var(--skill-learned-border); color: var(--skill-learned-text); font-weight: bold; }

        .sb-stats-bar {display: flex;justify-content: space-between;align-items: center;margin-bottom: 10px;font-size: 14px;color: var(--text-light);background: #f9f9f9;padding: 10px;border-radius: 6px;border: 1px solid var(--border);}

        .modal-overlay {position: absolute;top: 0; left: 0; right: 0; bottom: 0;background: rgba(0,0,0,0.6);display: flex;justify-content: center;align-items: center;padding: 20px;backdrop-filter: blur(2px);}
        .modal-content {background: white;width: 100%;max-width: 400px;border-radius: 12px;box-shadow: 0 10px 25px rgba(0,0,0,0.2);overflow: hidden;animation: modalPop 0.2s ease-out;display: flex;flex-direction: column;max-height: 85%;}
        @keyframes modalPop { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .modal-header { padding: 15px; background: #f8f9fa; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { margin: 0; font-size: 18px; color: var(--text); }
        .modal-close { background: none; border: none; font-size: 24px; color: #999; cursor: pointer; padding: 0 5px; }
        
        .modal-body { padding: 20px; overflow-y: auto; }
        .skill-detail-row { margin-bottom: 8px; font-size: 14px; display: flex; }
        .skill-detail-label { font-weight: bold; width: 50px; color: var(--text-light); flex-shrink: 0; }
        
        .skill-detail-desc { background: #f0f7ff; padding: 10px; border-radius: 6px; margin-top: 15px; color: #333; line-height: 1.6; font-size: 15px; border-left: 3px solid var(--primary);}
        
        .modal-footer { padding: 15px; border-top: 1px solid var(--border); text-align: center; }
        .btn-action { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-learn { background: var(--success); color: white; }
        .btn-forget { background: var(--accent); color: white; }
        .btn-locked { background: #ddd; color: #888; cursor: not-allowed; }

        .learned-list-group { margin-bottom: 15px; }
        .learned-list-class { font-weight: bold; color: var(--primary); margin-bottom: 5px; border-bottom: 1px solid var(--border); padding-bottom: 2px; }
        .learned-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f9f9f9; border-radius: 6px; margin-bottom: 5px; cursor: pointer; border: 1px solid transparent;}
        .learned-list-item:hover { background: #fff; border-color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .learned-item-name { font-weight: bold; font-size: 14px; }
        .learned-item-remove { color: var(--accent); font-weight: bold; padding: 2px 8px; border-radius: 4px; }
        .learned-item-remove:hover { background: rgba(255, 107, 107, 0.1); }
    </style>
</head>
<body>

<div id="app">
    <div class="tabs">
        <button class="tab-button" :class="{ active: currentTab === 'charCard' }" @click="currentTab = 'charCard'">
            è§’è‰²å¡
        </button>
        <button class="tab-button" :class="{ active: currentTab === 'skillTree' }" @click="currentTab = 'skillTree'">
            æŠ€èƒ½æ ‘
        </button>
        <button class="tab-button" :class="{ active: currentTab === 'skillBook' }" @click="currentTab = 'skillBook'">
            æŠ€èƒ½åˆ—è¡¨
        </button>
    </div>

    <div class="main-content">
        <div v-if="currentTab === 'charCard'" class="char-card-content">
            <div class="header">
                <h1>{{ character.name || 'æ–°è§’è‰²' }}</h1>
                <button @click="resetCharacter" style="margin-top: 10px; padding: 6px 12px; background-color: var(--warning); color: white; border: none; border-radius: 4px; cursor: pointer;">é‡ç½®è§’è‰²æ•°æ®</button>
            </div>

            <div class="input-group">
                <label for="char-name">è§’è‰²åç§°</label>
                <input id="char-name" type="text" v-model="character.name" placeholder="è¾“å…¥ä½ çš„è§’è‰²åç§°">
            </div>

            <div class="derived-hp-gem">
                <div class="hp-item" style="grid-column: span 2;">
                    <strong>ç”Ÿå‘½å€¼ (HP)</strong>
                    <div class="hp-value">
                        <span :class="{'current-hp-value': character.currentHp < derived.maxHp}">{{ character.currentHp }}</span> / {{ derived.maxHp }}
                    </div>
                    <div class="hp-adjust">
                        <button @click="updateCurrentHp(-hpChangeValue)">-</button>
                        <input type="number" v-model.number="hpChangeValue" placeholder="æ•°å€¼">
                        <button class="heal" @click="updateCurrentHp(hpChangeValue)">+</button>
                    </div>
                </div>
                
                <div class="derived-item"><strong>æ”»å‡»åŠ›</strong><span class="derived-value">{{ derived.attack }}</span></div>
                <div class="derived-item"><strong>å°„ç¨‹</strong><span class="derived-value">{{ derived.range }}</span></div>
                <div class="derived-item"><strong>ç§»åŠ¨åŠ›</strong><span class="derived-value">{{ derived.movement }}</span></div>
                <div class="derived-item"><strong>è¡ŒåŠ¨åŠ›</strong><span class="derived-value">{{ derived.action }}</span></div>
                
                <div class="gem-item" style="grid-column: span 2;">
                    <strong>å®çŸ³</strong>
                    <span class="gem-value">{{ character.gems }}</span>
                    <div class="gem-adjust">
                        <button @click="updateGem(-1)">-1</button>
                        <button @click="updateGem(1)">+1</button>
                    </div>
                </div>
            </div>

            <div class="stats-area">
                <h2>åŸºç¡€å±æ€§ (å·²åˆ†é…: {{ totalPoints }})</h2>
                <div v-for="(config, stat) in statConfigs" :key="stat" class="stat-item">
                    <span class="stat-name">{{ config.name }}</span>
                    <div class="stat-value">
                        <button @click="updateStat(stat, -1)" :disabled="character.stats[stat] <= 0">-</button>
                        <span class="stat-points">{{ character.stats[stat] }}</span>
                        <button @click="updateStat(stat, 1)" :disabled="character.stats[stat] >= config.max">+</button>
                    </div>
                </div>
            </div>

            <div class="notes-area">
                <label for="notes">å¤‡æ³¨ / ç¬”è®°</label>
                <textarea id="notes" v-model="character.notes" placeholder="è®°å½•ä»»ä½•å…¶ä»–ä¿¡æ¯..."></textarea>
            </div>
        </div>

        <div v-if="currentTab === 'skillTree'" class="skill-tree-content">
            <h2 style="text-align:center; font-size: 18px; margin-top:0;">æŠ€èƒ½æ ‘é¢„è§ˆ</h2>
            <select v-model="selectedClass">
                <option disabled value="">è¯·é€‰æ‹©ä¸€ä¸ªèŒä¸š</option>
                <option v-for="cls in availableClasses" :key="cls.id" :value="cls.id">{{ cls.name }}</option>
            </select>

            <div class="skill-tree-image-container">
                <img 
                    v-if="selectedClass && skillTreeImages[selectedClass]" 
                    :src="skillTreeImages[selectedClass]" 
                    alt="Skill Tree"
                    @dblclick.prevent
                    @contextmenu.prevent
                    @wheel.prevent="handleZoom"
                    @mousedown="startDrag" @mousemove="onDrag" @mouseup="stopDrag" @mouseleave="stopDrag"
                    @touchstart="handleTouchStart" @touchmove="handleTouchMove" @touchend="handleTouchEnd"
                    :class="{'is-dragging': dragState.isDragging}"
                    :style="imageTransformStyle"
                />
                <p v-else style="text-align: center; color: #999; margin-top: 150px;">
                    è¯·é€‰æ‹©èŒä¸šæŸ¥çœ‹æŠ€èƒ½å›¾è°±
                </p>
            </div>
            <p style="font-size: 12px; color: #999; text-align: center;">* åŒæŒ‡ç¼©æ”¾ / æ»šè½®ç¼©æ”¾ / æ‹–æ‹½ç§»åŠ¨</p>
        </div>

        <div v-if="currentTab === 'skillBook'" class="skill-book-content">
            <div class="sb-stats-bar">
                <span v-if="isLoadingSkills">æ­£åœ¨è¯»å– Excel...</span>
                <span v-else><strong>å·²å­¦æŠ€èƒ½:</strong> {{ sbLearnedCount }}</span>
                <div style="display:flex; gap:10px;">
                    <button @click="sbShowLearnedList = true" style="padding: 6px 10px; background: var(--primary); border:none; border-radius:4px; color:white; font-size:12px; font-weight:bold;">
                        ğŸ“œ æŸ¥çœ‹åˆ—è¡¨
                    </button>
                    <button @click="sbResetSkills" style="padding: 6px 10px; background: var(--warning); border:none; border-radius:4px; color:white; font-size:12px; font-weight:bold;">
                        é‡ç½®
                    </button>
                </div>
            </div>

            <div class="sb-nav-container">
                <div class="sb-class-nav" ref="classNavRef" 
                     @mousedown="navStartDrag" @mousemove="navOnDrag" @mouseup="navStopDrag" @mouseleave="navStopDrag">
                    <button v-for="cls in sbClassList" :key="cls" 
                        class="sb-class-btn" 
                        :class="{ active: sbCurrentClass === cls }"
                        @click="handleClassClick(cls)">
                        {{ cls }}
                    </button>
                </div>
            </div>

            <div v-if="isLoadingSkills" style="text-align: center; color: #999; margin-top: 50px;">
                æ­£åœ¨åŠ è½½æ•°æ®...<br>
                <small>è¯·ç¡®ä¿ 'SpellBook2.xlsx' æ–‡ä»¶å­˜åœ¨ä¸”æ‚¨æ­£åœ¨ä½¿ç”¨æœåŠ¡å™¨ç¯å¢ƒè¿è¡Œã€‚</small>
            </div>
            <div v-else-if="sbCurrentClass && sbTieredSkills" class="sb-skill-list">
                <div v-for="(skills, tier) in sbTieredSkills" :key="tier" class="sb-tier-row">
                    <div class="sb-tier-label">{{ toRoman(Number(tier) + 1) }}</div>
                    <div class="sb-tier-skills">
                        <div v-for="skill in skills" :key="skill.name" 
                             class="sb-skill-card"
                             :class="sbGetSkillStatus(skill.name)"
                             @click="sbOpenDetail(skill)">
                            <div class="sb-skill-name">{{ skill.name }}</div>
                            <div class="sb-skill-type">{{ skill.type }}</div>
                        </div>
                    </div>
                </div>
            </div>
            <div v-else style="text-align: center; color: #999; margin-top: 50px;">
                è¯¥èŒä¸šæš‚æ— æ•°æ®æˆ–æ–‡ä»¶è¯»å–å¤±è´¥
            </div>
        </div>
    </div>

    <div v-if="sbDetailSkill" class="modal-overlay" style="z-index: 60;" @click.self="sbCloseDetail">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    {{ sbDetailSkill.name }}
                    <span style="font-size: 12px; margin-left: 5px; color: var(--text-light);">({{ sbDetailSkill.type }})</span>
                </h3>
                <button class="modal-close" @click="sbCloseDetail">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="skill-detail-row">
                    <span class="skill-detail-label">å‰ç½®:</span>
                    <span v-if="sbDetailSkill.preReqs.length">
                        <span v-for="(req, idx) in sbDetailSkill.preReqs" :key="req"
                              :style="{color: sbLearnedSkills.has(req) ? 'var(--success)' : 'var(--accent)'}">
                            {{ req }}{{ idx < sbDetailSkill.preReqs.length-1 ? ', ' : '' }}
                        </span>
                    </span>
                    <span v-else>æ— </span>
                </div>
                <div class="skill-detail-row">
                    <span class="skill-detail-label">å†·å´:</span>
                    <span>{{ sbDetailSkill.cd || 'æ— ' }}</span>
                </div>
                <div class="skill-detail-desc" v-html="formatSkillEffect(sbDetailSkill.effect)"></div>
            </div>
            <div class="modal-footer">
                <button v-if="sbGetSkillStatus(sbDetailSkill.name) === 'learned'" class="btn-action btn-forget" @click="sbToggleAndClose(sbDetailSkill.name)">
                    é—å¿˜æŠ€èƒ½
                </button>
                <button v-else-if="sbGetSkillStatus(sbDetailSkill.name) === 'available'" class="btn-action btn-learn" @click="sbToggleAndClose(sbDetailSkill.name)">
                    å­¦ä¹ æŠ€èƒ½
                </button>
                <button v-else class="btn-action btn-locked" disabled>
                    å‰ç½®æœªæ»¡è¶³
                </button>
            </div>
        </div>
    </div>

    <div v-if="sbShowLearnedList" class="modal-overlay" style="z-index: 50;" @click.self="sbShowLearnedList = false">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">å·²å­¦æŠ€èƒ½ ({{ sbLearnedCount }})</h3>
                <button class="modal-close" @click="sbShowLearnedList = false">Ã—</button>
            </div>
            <div class="modal-body" style="background-color: #f5f5f5;">
                <div v-if="sbLearnedCount === 0" style="text-align:center; padding: 20px; color:#999;">
                    ä½ è¿˜æ²¡æœ‰å­¦ä¹ ä»»ä½•æŠ€èƒ½ã€‚
                </div>
                <div v-for="(skills, cls) in sbLearnedListGrouped" :key="cls" class="learned-list-group">
                    <div class="learned-list-class">{{ cls }}</div>
                    <div v-for="skill in skills" :key="skill.name" class="learned-list-item" @click="sbOpenDetail(skill)">
                        <span class="learned-item-name">{{ skill.name }}</span>
                        <span class="learned-item-remove" @click.stop="sbToggleSkill(skill.name)">Ã—</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-action btn-forget" @click="sbResetSkills">å…¨éƒ¨é‡ç½®</button>
            </div>
        </div>
    </div>

</div>

<script>
    const { ref, reactive, computed, watch, onMounted, nextTick } = Vue;

    const excelFileName = 'SpellBook2.xlsx';

    // --- ä¿ç•™ä¸€ä»½æœ€å°åŒ–çš„åå¤‡æ•°æ®ï¼Œé˜²æ­¢åŠ è½½å®Œå…¨å¤±è´¥æ—¶é¡µé¢ç©ºç™½ ---
    const fallbackRawSkillData = {
        "ç¤ºä¾‹èŒä¸š": `Ability,Pre-requisite,Type,Cool Down,Effect
ç¤ºä¾‹æŠ€èƒ½,,ä¸»åŠ¨,1,è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹æŠ€èƒ½ï¼Œè¯·ç¡®ä¿ SpellBook2.xlsx æ–‡ä»¶å­˜åœ¨`
    };

    // --- è§’è‰²å¡å¸¸é‡ ---
    const defaultStats = { str: 0, per: 0, con: 0, cha: 0, int: 0, dex: 0 };
    const statConfigs = {
        str: { name: 'åŠ›é‡', max: 20 }, per: { name: 'æ„ŸçŸ¥', max: 20 }, con: { name: 'ä½“è´¨', max: 20 }, 
        cha: { name: 'é­…åŠ›', max: 20 }, int: { name: 'æ™ºåŠ›', max: 20 }, dex: { name: 'æ•æ·', max: 20 },
    };
    const skillTreeImages = {
        mage: 'æ³•å¸ˆæŠ€èƒ½.png', assassin: 'åˆºå®¢æŠ€èƒ½.png', druid: 'å¾·é²ä¼ŠæŠ€èƒ½.png', 
        warrior: 'æˆ˜å£«æŠ€èƒ½.png', priest: 'ç‰§å¸ˆæŠ€èƒ½.png', hunter: 'çŒäººæŠ€èƒ½.png', 
        warlock: 'æœ¯å£«æŠ€èƒ½.png', knight: 'éª‘å£«æŠ€èƒ½.png', bard: 'åŸæ¸¸è¯—äººæŠ€èƒ½.png', 
        shaman: 'è¨æ»¡æŠ€èƒ½.png',
    };
    const availableClasses = [
        { id: 'mage', name: 'æ³•å¸ˆ' }, { id: 'assassin', name: 'åˆºå®¢' }, { id: 'druid', name: 'å¾·é²ä¼Š' }, 
        { id: 'warrior', name: 'æˆ˜å£«' }, { id: 'priest', name: 'ç‰§å¸ˆ' }, { id: 'hunter', name: 'çŒäºº' }, 
        { id: 'warlock', name: 'æœ¯å£«' }, { id: 'knight', name: 'éª‘å£«' }, { id: 'bard', name: 'åŸæ¸¸è¯—äºº' }, 
        { id: 'shaman', name: 'è¨æ»¡' },
    ];

    Vue.createApp({
        setup() {
            // --- å…¨å±€çŠ¶æ€ ---
            const currentTab = ref('charCard');
            const isLoadingSkills = ref(false);
            
            // --- è§’è‰²å¡çŠ¶æ€ ---
            const character = reactive({
                name: '', stats: { ...defaultStats }, currentHp: 0, gems: 0, notes: ''
            });
            const hpChangeValue = ref(1);
            const totalPoints = computed(() => Object.values(character.stats).reduce((sum, val) => sum + val, 0));
            const derived = computed(() => {
                const { str, per, con, dex, int } = character.stats;
                return { attack: str, range: per, maxHp: 6 + (con * 6), movement: 2 + Math.floor(dex / 2), action: 1 + int };
            });

            // --- æŠ€èƒ½æ ‘(å›¾) çŠ¶æ€ ---
            const selectedClass = ref('');
            const zoomState = reactive({ scale: 1.0, x: 0, y: 0 });
            const dragState = reactive({ isDragging: false, startX: 0, startY: 0, startTransX: 0, startTransY: 0 });
            const touchState = reactive({ initialDistance: 0, initialScale: 1.0, isPinching: false });
            
            const imageTransformStyle = computed(() => ({
                transform: `translate3d(${zoomState.x}px, ${zoomState.y}px, 0) scale(${zoomState.scale})`,
                transition: (dragState.isDragging || touchState.isPinching) ? 'none' : 'transform 0.1s ease-out',
            }));

            // --- æŠ€èƒ½ä¹¦ (Skill Book) çŠ¶æ€ä¸é€»è¾‘ ---
            const sbAllSkills = reactive({}); 
            const sbLearnedSkills = reactive(new Set()); 
            const sbCurrentClass = ref('');
            const sbDetailSkill = ref(null); 
            const sbShowLearnedList = ref(false); 
            const sbAncestorsCache = {};
            const classNavRef = ref(null); 
            const navDragState = reactive({ isDragging: false, startX: 0, scrollLeft: 0 });
            const sbDetectedClasses = reactive(new Set()); // å­˜å‚¨ä»Excelæ£€æµ‹åˆ°çš„èŒä¸šå

            // è§£æ CSV å†…å®¹ (å¤ç”¨é€»è¾‘)
            const parseCSVContent = (className, csvContent) => {
                const lines = csvContent.split('\n');
                let startIndex = 0;
                
                // ç®€å•çš„è¡¨å¤´æ£€æµ‹ï¼Œè·³è¿‡ header è¡Œ
                if (lines.length > 0 && (lines[0].includes('Ability') || lines[0].includes('source'))) {
                    startIndex = 1;
                }

                for (let i = startIndex; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const parts = [];
                    let lastIndex = 0;
                    let commasFound = 0;
                    for(let c=0; c<line.length; c++) {
                        if(line[c] === ',') {
                            commasFound++;
                            if (commasFound <= 4) { 
                                parts.push(line.substring(lastIndex, c));
                                lastIndex = c + 1;
                            }
                        }
                    }
                    parts.push(line.substring(lastIndex));
                    
                    if (parts.length < 5) continue;
                    
                    const name = parts[0].trim();
                    if (!name || name.startsWith('[')) continue; 

                    const preRaw = parts[1].trim();
                    const type = parts[2].trim();
                    const cd = parts[3].trim();
                    const effect = parts[4].trim();
                    
                    let preReqs = [];
                    if (preRaw) preReqs = preRaw.replace(/"/g, '').split(/[ï¼Œ, ]+/).filter(s => s.trim() !== "");
                    
                    sbAllSkills[name] = { name, className, preReqs, type, cd, effect };
                }
            };

            // ğŸŒŸ æ ¸å¿ƒä¿®æ”¹ï¼šè¯»å–å¹¶è§£æ Excel æ–‡ä»¶
            const fetchAndParseExcel = async () => {
                isLoadingSkills.value = true;
                
                try {
                    const response = await fetch(excelFileName);
                    if (!response.ok) throw new Error(`æ— æ³•æ‰¾åˆ°æ–‡ä»¶: ${excelFileName}`);
                    
                    const arrayBuffer = await response.arrayBuffer();
                    const workbook = XLSX.read(arrayBuffer, { type: 'array' });

                    // éå†æ‰€æœ‰å·¥ä½œè¡¨ (Sheets)
                    workbook.SheetNames.forEach(sheetName => {
                        const worksheet = workbook.Sheets[sheetName];
                        // å°† Sheet è½¬æ¢ä¸º CSV æ ¼å¼
                        const csv = XLSX.utils.sheet_to_csv(worksheet);
                        
                        // ç®€å•æ£€æŸ¥è¯¥ Sheet æ˜¯å¦åŒ…å«æŠ€èƒ½æ•°æ® (å«æœ‰ "Ability" å…³é”®å­—)
                        if (csv.includes('Ability') || csv.includes('Type') || csv.includes('Effect')) {
                            console.log(`æ­£åœ¨è§£æèŒä¸š: ${sheetName}`);
                            sbDetectedClasses.add(sheetName);
                            parseCSVContent(sheetName, csv);
                        } else {
                            console.log(`è·³è¿‡å·¥ä½œè¡¨: ${sheetName} (æœªæ£€æµ‹åˆ°æŠ€èƒ½æ•°æ®æ ¼å¼)`);
                        }
                    });

                } catch (error) {
                    console.error('Excel è¯»å–å¤±è´¥:', error);
                    console.warn('å›é€€åˆ°æœ¬åœ°ç¡¬ç¼–ç æ•°æ®...');
                    // å›é€€é€»è¾‘
                    for (const [cls, content] of Object.entries(fallbackRawSkillData)) {
                        sbDetectedClasses.add(cls);
                        parseCSVContent(cls, content);
                    }
                } finally {
                    isLoadingSkills.value = false;
                    // å¦‚æœæ£€æµ‹åˆ°äº†èŒä¸šï¼Œé»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
                    if (sbDetectedClasses.size > 0 && !sbCurrentClass.value) {
                         // ä¼˜å…ˆé€‰ä¸­ "æˆ˜å£«" å¦‚æœå­˜åœ¨ï¼Œå¦åˆ™é€‰ä¸­ç¬¬ä¸€ä¸ª
                        if (sbDetectedClasses.has('æˆ˜å£«')) sbCurrentClass.value = 'æˆ˜å£«';
                        else sbCurrentClass.value = Array.from(sbDetectedClasses)[0];
                    }
                }
            };

            const getAncestorsCount = (skillName, visited = new Set()) => {
                if (sbAncestorsCache[skillName] !== undefined) return sbAncestorsCache[skillName];
                const skill = sbAllSkills[skillName];
                if (!skill) return 0;
                if (visited.has(skillName)) return 0; 
                visited.add(skillName);
                
                const collectAncestors = (name, set) => {
                    const s = sbAllSkills[name];
                    if(!s) return;
                    s.preReqs.forEach(p => {
                        if(!set.has(p)) {
                            set.add(p);
                            collectAncestors(p, set);
                        }
                    });
                };
                const fullAncestors = new Set();
                collectAncestors(skillName, fullAncestors);
                sbAncestorsCache[skillName] = fullAncestors.size;
                return fullAncestors.size;
            };

            // åŠ¨æ€ Class List
            const sbClassList = computed(() => Array.from(sbDetectedClasses));

            const sbTieredSkills = computed(() => {
                if (!sbCurrentClass.value) return null;
                const skills = Object.values(sbAllSkills).filter(s => s.className === sbCurrentClass.value);
                const tiers = {};
                skills.forEach(skill => {
                    const count = getAncestorsCount(skill.name);
                    if (!tiers[count]) tiers[count] = [];
                    tiers[count].push(skill);
                });
                return tiers;
            });

            const sbLearnedCount = computed(() => sbLearnedSkills.size);
            
            const sbLearnedListGrouped = computed(() => {
                const grouped = {};
                sbLearnedSkills.forEach(name => {
                    const skill = sbAllSkills[name];
                    if (skill) {
                        if (!grouped[skill.className]) grouped[skill.className] = [];
                        grouped[skill.className].push(skill);
                    }
                });
                return grouped;
            });

            const sbGetSkillStatus = (skillName) => {
                if (sbLearnedSkills.has(skillName)) return 'learned';
                const skill = sbAllSkills[skillName];
                if (!skill) return 'locked';
                if (skill.preReqs.length === 0) return 'available';
                const allMet = skill.preReqs.every(req => sbLearnedSkills.has(req));
                return allMet ? 'available' : 'locked';
            };

            const sbOpenDetail = (skill) => { sbDetailSkill.value = skill; };
            const sbCloseDetail = () => { sbDetailSkill.value = null; };

            const sbToggleSkill = (skillName) => {
                const status = sbGetSkillStatus(skillName);
                if (status === 'available') {
                    sbLearnedSkills.add(skillName);
                } else if (status === 'learned') {
                    const toRemove = [skillName];
                    let changed = true;
                    while(changed) {
                        changed = false;
                        sbLearnedSkills.forEach(s => {
                            if (toRemove.includes(s)) return;
                            const sObj = sbAllSkills[s];
                            if (sObj.preReqs.some(req => toRemove.includes(req))) {
                                toRemove.push(s);
                                changed = true;
                            }
                        });
                    }
                    toRemove.forEach(s => sbLearnedSkills.delete(s));
                }
                saveSkillBookData();
            };

            const sbToggleAndClose = (skillName) => {
                sbToggleSkill(skillName);
                sbCloseDetail();
            };
            
            const formatSkillEffect = (text) => {
                if (!text) return '';
                return text
                    .replace(/,/g, ',<br>')
                    .replace(/ï¼Œ/g, 'ï¼Œ<br>')
                    .replace(/\./g, '<br><br>') 
                    .replace(/ã€‚/g, '<br><br>');
            };

            const sbResetSkills = () => {
                if(confirm('ç¡®å®šé‡ç½®æ‰€æœ‰å·²å­¦æŠ€èƒ½å—ï¼Ÿ')) {
                    sbLearnedSkills.clear();
                    saveSkillBookData();
                    sbDetailSkill.value = null;
                    sbShowLearnedList.value = false;
                }
            };

            const toRoman = (num) => {
                if (num < 1) return "";
                const lookup = {M:1000,CM:900,D:500,CD:400,C:100,XC:90,L:50,XL:40,X:10,IX:9,V:5,IV:4,I:1};
                let roman = '';
                for (let i in lookup ) {
                    while ( num >= lookup[i] ) {
                        roman += i;
                        num -= lookup[i];
                    }
                }
                return roman;
            };

            // --- èŒä¸šå¯¼èˆªæ æ‹–æ‹½é€»è¾‘ ---
            const navStartDrag = (e) => {
                navDragState.isDragging = true;
                navDragState.startX = e.pageX - classNavRef.value.offsetLeft;
                navDragState.scrollLeft = classNavRef.value.scrollLeft;
            };
            const navOnDrag = (e) => {
                if (!navDragState.isDragging) return;
                e.preventDefault();
                const x = e.pageX - classNavRef.value.offsetLeft;
                const walk = (x - navDragState.startX) * 2; 
                classNavRef.value.scrollLeft = navDragState.scrollLeft - walk;
            };
            const navStopDrag = () => { navDragState.isDragging = false; };
            const handleClassClick = (cls) => {
                sbCurrentClass.value = cls;
            };


            // --- æŒä¹…åŒ–é€»è¾‘ ---
            const saveCharData = () => localStorage.setItem('rpg-char-data-v5', JSON.stringify(character));
            const saveSkillBookData = () => localStorage.setItem('rpg-skillbook-v1', JSON.stringify([...sbLearnedSkills]));

            // --- è§’è‰²å¡é€»è¾‘ ---
            const updateStat = (stat, change) => {
                const current = character.stats[stat];
                if (change > 0 && current < statConfigs[stat].max) character.stats[stat]++;
                else if (change < 0 && current > 0) character.stats[stat]--;
            };
            const updateGem = (change) => character.gems = Math.max(0, character.gems + change);
            const updateCurrentHp = (change) => {
                character.currentHp = Math.min(derived.value.maxHp, Math.max(0, character.currentHp + change));
                hpChangeValue.value = 1;
            };
            const resetCharacter = () => {
                if (confirm('ç¡®å®šé‡ç½®è§’è‰²æ•°æ®?')) {
                    character.name = '';
                    character.stats = { ...defaultStats }; 
                    character.gems = 0;
                    character.notes = '';
                    nextTick(() => { character.currentHp = 6; });
                }
            };

            // --- æŠ€èƒ½æ ‘(å›¾) äº¤äº’é€»è¾‘ ---
            const startDrag = (e) => {
                if (e.button !== 0 || zoomState.scale === 1.0) return;
                dragState.isDragging = true;
                dragState.startX = e.clientX; dragState.startY = e.clientY;
                dragState.startTransX = zoomState.x; dragState.startTransY = zoomState.y;
                e.preventDefault();
            };
            const onDrag = (e) => {
                if (!dragState.isDragging) return;
                zoomState.x = dragState.startTransX + (e.clientX - dragState.startX);
                zoomState.y = dragState.startTransY + (e.clientY - dragState.startY);
                e.preventDefault();
            };
            const stopDrag = () => { dragState.isDragging = false; };
            const handleZoom = (e) => {
                e.preventDefault();
                if (dragState.isDragging) return;
                const rect = e.currentTarget.getBoundingClientRect();
                const direction = e.deltaY < 0 ? 1 : -1;
                const newScale = Math.min(4.0, Math.max(1.0, zoomState.scale + direction * 0.1));
                if (newScale === zoomState.scale) return;
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                const newX = zoomState.x + mouseX * (1 - newScale / zoomState.scale);
                const newY = zoomState.y + mouseY * (1 - newScale / zoomState.scale);
                zoomState.scale = newScale;
                if (newScale === 1.0) { zoomState.x = 0; zoomState.y = 0; } else { zoomState.x = newX; zoomState.y = newY; }
            };
            const getDistance = (touches) => Math.hypot(touches[0].clientX - touches[1].clientX, touches[0].clientY - touches[1].clientY);
            const handleTouchStart = (e) => {
                if (e.touches.length === 1 && zoomState.scale > 1.0) {
                    dragState.isDragging = true;
                    dragState.startX = e.touches[0].clientX; dragState.startY = e.touches[0].clientY;
                    dragState.startTransX = zoomState.x; dragState.startTransY = zoomState.y;
                } else if (e.touches.length === 2) {
                    dragState.isDragging = false;
                    touchState.isPinching = true;
                    touchState.initialDistance = getDistance(e.touches);
                    touchState.initialScale = zoomState.scale;
                }
            };
            const handleTouchMove = (e) => {
                e.preventDefault();
                if (e.touches.length === 1 && dragState.isDragging) {
                    zoomState.x = dragState.startTransX + (e.touches[0].clientX - dragState.startX);
                    zoomState.y = dragState.startTransY + (e.touches[0].clientY - dragState.startY);
                } else if (e.touches.length === 2 && touchState.isPinching) {
                    const dist = getDistance(e.touches);
                    if (touchState.initialDistance > 0) {
                        const newScale = Math.min(4.0, Math.max(1.0, touchState.initialScale * (dist / touchState.initialDistance)));
                        zoomState.scale = newScale;
                        if (newScale === 1.0) { zoomState.x = 0; zoomState.y = 0; }
                    }
                }
            };
            const handleTouchEnd = (e) => {
                if (e.touches.length < 2) touchState.isPinching = false;
                if (e.touches.length === 0) dragState.isDragging = false;
            };

            // --- ç”Ÿå‘½å‘¨æœŸ ---
            onMounted(() => {
                // å¯åŠ¨ Excel æ•°æ®åŠ è½½
                fetchAndParseExcel();

                const savedChar = localStorage.getItem('rpg-char-data-v5');
                if (savedChar) {
                    const parsed = JSON.parse(savedChar);
                    character.name = parsed.name || '';
                    if (parsed.stats) character.stats = { ...defaultStats, ...parsed.stats };
                    character.gems = parsed.gems || 0;
                    character.notes = parsed.notes || '';
                    const maxHpOnLoad = 6 + (character.stats.con * 6);
                    character.currentHp = Math.min(maxHpOnLoad, parsed.currentHp !== undefined ? parsed.currentHp : maxHpOnLoad);
                } else {
                    character.currentHp = derived.value.maxHp;
                }

                const savedSkills = localStorage.getItem('rpg-skillbook-v1');
                if (savedSkills) {
                    JSON.parse(savedSkills).forEach(s => sbLearnedSkills.add(s));
                }
            });

            watch(character, saveCharData, { deep: true });
            watch(() => derived.value.maxHp, (n, o) => {
                const diff = n - o;
                if (diff > 0) character.currentHp += diff;
                else if (diff < 0) character.currentHp = Math.max(1, character.currentHp + diff);
            });
            watch(currentTab, (newTab) => {
                if (newTab === 'charCard' || newTab === 'skillBook') {
                    zoomState.scale = 1.0; zoomState.x = 0; zoomState.y = 0;
                }
            });

            return {
                currentTab, character, hpChangeValue, derived, totalPoints, statConfigs,
                updateStat, updateGem, updateCurrentHp, resetCharacter,
                // æŠ€èƒ½æ ‘(å›¾)
                selectedClass, availableClasses, skillTreeImages, zoomState, dragState, imageTransformStyle,
                handleZoom, startDrag, onDrag, stopDrag, handleTouchStart, handleTouchMove, handleTouchEnd,
                // æŠ€èƒ½ä¹¦(å…¨)
                sbClassList, sbCurrentClass, sbTieredSkills, sbLearnedCount, sbLearnedSkills,
                sbGetSkillStatus, sbDetailSkill, sbOpenDetail, sbCloseDetail, sbToggleSkill, sbResetSkills,
                sbShowLearnedList, sbLearnedListGrouped, 
                classNavRef, navStartDrag, navOnDrag, navStopDrag, handleClassClick,
                toRoman, sbToggleAndClose, formatSkillEffect,
                isLoadingSkills
            };
        }
    }).mount('#app');
</script>
</body>
</html>
